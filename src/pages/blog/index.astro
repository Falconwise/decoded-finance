---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '../../utils/utils';

const posts = await getCollection('blog');
const sortedPosts = posts.sort((a, b) =>
  new Date(b.data.publishedDate).getTime() - new Date(a.data.publishedDate).getTime()
);

const allTags = [...new Set(sortedPosts.flatMap(p => p.data.tags))].sort();
const featuredPost = sortedPosts.find(post => post.data.featured) ?? sortedPosts[0];
const latestPosts = sortedPosts.filter(post => post.slug !== featuredPost.slug);
---

<BaseLayout
  title="Blog"
  description="Corporate finance, valuation, and Saudi capital markets commentary. Practical frameworks and analysis for professionals."
>
  <section class="section bg-alabaster">
    <div class="container">
      <header class="max-w-3xl mb-10 md:mb-12">
        <p class="label text-copper mb-3">Insights</p>
        <h1 class="mb-4">Research Journal</h1>
        <p class="text-gray-600 text-lg leading-relaxed">
          Long-form analysis on valuation, treasury, and Saudi capital markets — written for decision-makers who value clarity over noise.
        </p>
      </header>

      <section class="mb-12" aria-label="Featured article">
        <article class="bg-white border border-gray-200 rounded-xl p-6 md:p-8 shadow-sm">
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <span class="badge badge-copper">Featured</span>
            <span class="meta">{formatDate(featuredPost.data.publishedDate)} · {featuredPost.data.reading_time} min read</span>
          </div>
          <h2 class="text-2xl md:text-3xl mb-3 leading-tight">
            <a href={`/blog/${featuredPost.slug}`} class="text-graphite no-underline hover:text-sage transition-colors">
              {featuredPost.data.title}
            </a>
          </h2>
          <p class="text-gray-600 max-w-3xl leading-relaxed mb-5">{featuredPost.data.description}</p>
          <div class="flex flex-wrap gap-2 mb-6">
            {featuredPost.data.tags.map(tag => (
              <span class="badge bg-sage-50 text-sage-700">{tag}</span>
            ))}
          </div>
          <a href={`/blog/${featuredPost.slug}`} class="btn-secondary">Read featured analysis →</a>
        </article>
      </section>

      <section aria-label="Browse by topic" class="mb-8 md:mb-10">
        <div class="flex flex-wrap gap-2">
          <span class="badge badge-sage">All Topics</span>
          {allTags.map(tag => (
            <span class="badge bg-white text-gray-600 border border-gray-200">{tag}</span>
          ))}
        </div>
      </section>

      <section aria-label="Latest articles" class="space-y-4">
        {latestPosts.map(post => (
          <article class="bg-white border border-gray-200 rounded-xl p-5 md:p-6 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="max-w-3xl">
                <h3 class="text-xl mb-2 leading-snug">
                  <a href={`/blog/${post.slug}`} class="text-graphite no-underline hover:text-sage transition-colors">
                    {post.data.title}
                  </a>
                </h3>
                <p class="text-gray-600 leading-relaxed mb-4">{post.data.description}</p>
                <div class="flex flex-wrap gap-2">
                  {post.data.tags.slice(0, 4).map(tag => (
                    <span class="text-xs uppercase tracking-wide text-gray-500 bg-gray-50 px-2 py-1 rounded">{tag}</span>
                  ))}
                </div>
              </div>
              <div class="md:text-right shrink-0">
                <p class="meta mb-3">{formatDate(post.data.publishedDate)} · {post.data.reading_time} min</p>
                <a href={`/blog/${post.slug}`} class="text-copper font-bold text-sm no-underline hover:underline">Read article →</a>
              </div>
            </div>
          </article>
        ))}
      </section>
    </div>
  </section>
</BaseLayout>
