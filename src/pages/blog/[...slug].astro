---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '../../utils/utils';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  type="article"
  publishedDate={post.data.publishedDate}
  ogImage={post.data.ogImage}
>
  <!-- Reading progress bar -->
  <div id="reading-progress" aria-hidden="true"></div>

  <!-- Post hero header -->
  <div class="post-hero">
    <div class="container">
      <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 list-none p-0 m-0" style="font-size: 0.85rem; color: #7a9172;">
          <li><a href="/" class="no-underline hover:text-white transition-colors">Home</a></li>
          <li aria-hidden="true" style="color: #4a5e45;">/</li>
          <li><a href="/blog" class="no-underline hover:text-white transition-colors">Blog</a></li>
        </ol>
      </nav>

      <div class="flex flex-wrap gap-2 mb-5">
        {post.data.tags.map(tag => (
          <a href={`/blog?topic=${encodeURIComponent(tag)}`} class="post-hero-tag">{tag}</a>
        ))}
      </div>

      <h1 class="post-hero-title">{post.data.title}</h1>
      <p class="post-hero-desc">{post.data.description}</p>

      <div class="post-hero-meta">
        <span style="color: #d4e4ce; font-weight: 600;">{post.data.author}</span>
        <span class="post-hero-dot">·</span>
        <span>{formatDate(post.data.publishedDate)}</span>
        <span class="post-hero-dot">·</span>
        <span>{post.data.reading_time} min read</span>
      </div>
    </div>
  </div>

  <!-- Body -->
  <div class="section bg-white" style="padding-top: 3rem;">
    <div class="container">
      <div class="post-grid">

        <!-- Main content -->
        <main class="post-content min-w-0">
          <div class="reading-prose">
            <Content />
          </div>

          <aside class="mt-12 p-5 md:p-6 bg-alabaster border border-gray-200 rounded-xl" aria-label="Disclaimer">
            <p class="text-xs text-gray-500 m-0 leading-relaxed">
              <strong>Disclaimer:</strong> This analysis reflects personal research and opinions prepared for educational purposes only.
              It is not a recommendation to buy, sell, or hold any security or financial instrument.
              Always do your own research and consult a licensed financial professional before making investment decisions.
            </p>
          </aside>

          <section class="mt-8 p-6 bg-alabaster rounded-xl border border-gray-200" aria-label="Author">
            <div class="flex items-start gap-4">
              <div class="shrink-0 w-11 h-11 rounded-full flex items-center justify-center text-white font-bold text-base" style="background: #7A8B72; font-family: var(--font-heading);">A</div>
              <div>
                <p class="font-bold text-graphite mb-1" style="font-family: var(--font-heading); font-size: 1rem;">{post.data.author}</p>
                <p class="text-gray-600 text-sm leading-relaxed m-0">
                  Corporate Treasury Professional managing SAR 1bn+ banking facilities.
                  Building decoded.finance to provide independent, rigorous analysis of Saudi capital markets.
                </p>
              </div>
            </div>
          </section>

          <section class="mt-8 pt-6 border-t border-gray-200" aria-label="Topics">
            <p class="label text-gray-400 mb-3" style="font-size: 0.68rem;">Filed under</p>
            <div class="flex flex-wrap gap-2 mb-6">
              {post.data.tags.map(tag => (
                <a href={`/blog?topic=${encodeURIComponent(tag)}`} class="badge badge-sage no-underline hover:opacity-80 transition-opacity">{tag}</a>
              ))}
            </div>
            <a href="/blog" class="btn-secondary" style="font-size: 0.875rem; padding: 8px 18px;">← All Posts</a>
          </section>
        </main>

        <!-- Sticky sidebar -->
        <aside class="post-sidebar" aria-label="Article navigation">
          <div class="sidebar-sticky">

            <!-- Table of Contents (populated by JS) -->
            <nav id="toc-container" aria-label="Table of contents" style="display: none;">
              <p class="label mb-3" style="font-size: 0.68rem; color: #9ca3af;">Contents</p>
              <ul id="toc-list" class="toc-list"></ul>
            </nav>

            <!-- Newsletter -->
            <div class="newsletter-sidebar">
              <p class="label mb-1" style="font-size: 0.68rem; color: #c5d4c0;">Newsletter</p>
              <h4 style="color: #fff; font-family: var(--font-heading); font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.3;">Get Analysis Delivered</h4>
              <p style="color: #b0c4ab; font-size: 0.82rem; line-height: 1.6; margin-bottom: 1rem;">
                Saudi IPO insights for finance professionals. No spam.
              </p>
              <form action="https://formspree.io/f/xbdaavoa" method="POST" class="flex flex-col gap-2">
                <input type="hidden" name="_subject" value="New subscriber — decoded.finance (blog post)" />
                <input type="hidden" name="_next" value="https://decoded.finance/?subscribed=true" />
                <input
                  type="email"
                  name="email"
                  placeholder="your@email.com"
                  required
                  style="padding: 8px 12px; border-radius: 4px; border: 0; font-size: 0.82rem; color: #333; width: 100%; box-sizing: border-box;"
                />
                <button
                  type="submit"
                  style="padding: 8px 12px; background: #B86E4B; color: #fff; border: none; border-radius: 4px; font-weight: 700; font-size: 0.82rem; cursor: pointer; width: 100%;"
                >
                  Subscribe →
                </button>
              </form>
            </div>

          </div>
        </aside>

      </div>
    </div>
  </div>

  <script>
    // Reading progress bar
    const progressBar = document.getElementById('reading-progress');
    const content = document.querySelector('.reading-prose') as HTMLElement | null;
    if (progressBar && content) {
      const update = () => {
        const rect = content.getBoundingClientRect();
        const scrolled = Math.max(0, Math.min(1, -rect.top / (content.scrollHeight - window.innerHeight)));
        progressBar.style.width = `${scrolled * 100}%`;
      };
      window.addEventListener('scroll', update, { passive: true });
      update();
    }

    // Auto-generate Table of Contents from h2/h3 headings
    const headings = document.querySelectorAll('.reading-prose h2, .reading-prose h3');
    const tocList = document.getElementById('toc-list');
    const tocContainer = document.getElementById('toc-container');
    if (tocList && tocContainer && headings.length >= 2) {
      headings.forEach((h, i) => {
        if (!h.id) h.id = `s${i}`;
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${h.id}`;
        a.textContent = h.textContent ?? '';
        a.className = h.tagName === 'H3' ? 'toc-link toc-h3' : 'toc-link toc-h2';
        li.appendChild(a);
        tocList.appendChild(li);
      });
      tocContainer.style.display = 'block';

      // Highlight active section on scroll
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const id = entry.target.id;
          const link = tocList.querySelector(`a[href="#${id}"]`);
          if (link) link.classList.toggle('toc-link-active', entry.isIntersecting);
        });
      }, { rootMargin: '0px 0px -60% 0px' });
      headings.forEach(h => observer.observe(h));
    }
  </script>
</BaseLayout>
