---
import BaseLayout from '../layouts/BaseLayout.astro';
import IPOTable from '../components/ipo-tracker/IPOTable';
import { getCollection } from 'astro:content';
import { ipoData, getPublicIPOs, getUniqueSectors, getAvailableYears } from '../data/ipo-data';

const publicIPOs = getPublicIPOs();
const sectors = getUniqueSectors();
const years = getAvailableYears();
const caseStudies = await getCollection('case-studies');
const availableCaseStudySlugs = caseStudies.map((study) => study.slug);
---

<BaseLayout
  title="Saudi IPO Tracker"
  description="Complete database of Saudi Arabian IPOs with performance data. Track all IPOs across TASI and Nomu markets from 2020 to present."
>
  <section class="section bg-alabaster">
    <div class="container">
      <!-- Page Header -->
      <div class="mb-8">
        <p class="label text-copper mb-2">Live Database</p>
        <h1 class="mb-3">Saudi IPO Tracker</h1>
        <p class="text-gray-600 max-w-2xl">
          Complete database of Saudi Arabian IPOs across TASI (Main Market) and Nomu (Parallel Market),
          with live prices and P/E ratios updated daily after Tadawul market close.
          The single best free resource for studying Saudi capital markets.
        </p>
        <p class="meta mt-2">
          Data as of: {new Date(ipoData.metadata.last_updated).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
          &nbsp;·&nbsp;Prices updated daily after Tadawul close (3 pm AST)
        </p>
      </div>

      <!-- Interactive IPO Table (React Island — includes live summary stats) -->
      <div class="card p-4 md:p-6">
        <div class="mb-4 p-3 rounded bg-alabaster border border-gray-200">
          <p class="text-xs text-gray-600 m-0 leading-relaxed">
            <strong>Source:</strong> {ipoData.metadata.data_source}
            <span class="mx-2">•</span>
            <strong>Live prices:</strong> Yahoo Finance (Tadawul .SR tickers) via daily Cloudflare Worker cron
            <span class="mx-2">•</span>
            <strong>IPO data as of:</strong> {new Date(ipoData.metadata.last_updated).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
          </p>
        </div>
        <IPOTable
          client:load
          data={publicIPOs}
          sectors={sectors}
          years={years}
          availableCaseStudySlugs={availableCaseStudySlugs}
        />
      </div>

      <div class="mt-6 p-4 bg-white border border-gray-200 rounded-lg">
        <p class="text-xs text-gray-600 m-0 leading-relaxed">
          IPO tracker entries are informational snapshots. Live prices are sourced from Yahoo Finance via the Tadawul .SR ticker format and are updated once daily after market close — they may be delayed, incomplete, or revised.
          Market classifications (TASI / Nomu) are for informational purposes. This data does not constitute real-time market data or investment advice.
        </p>
      </div>
    </div>
  </section>
</BaseLayout>
